<!-- filepath: d:\VSCodeExtension\vscodeext\media\webview.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example Webview</title>
    <style>
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>
    <h1>TSO BUS</h1>
    <div class="row">
        <label for="libreriaInput">Libreria:</label>
        <input type="text" id="libreriaInput" value="T09579.JCLLIB(BU3)" />
    </div>
    <div class="row">
        <label for="elementoInput">Elemento:</label>
        <input type="text" id="elementoInput" value="BCVVCU20" />

        <div class="row">
            <label for="typeSelect">Tipo:</label>
            <select id="typeSelect">
                <option value="PRG">PRG</option>
                <option value="CPY">CPY</option>
                <option value="JOB">JOB</option>
                <option value="PRC">PRC</option>
                <option value="CTL">CTL</option>
                <option value="OBJ">OBJ</option>
            </select>
        </div>

        <div class="row">
            <button id="matriculaBuscar">Buscar</button>
            <progress id="progressBar" style="display: none;" max="100"></progress>
        </div>

        <p id="additionalOutput"></p>
    </div>
    commandOutput <p id="commandOutput">commandOutput</p>

    errorOutput <p id="errorOutput">Error output will appear here</p>
    stderrOutput <p id="stderrOutput">Stderr output will appear here</p>
    stdoutOutput <p id="stdoutOutput">Stdout output will appear here</p>

    <script>
        const vscode = acquireVsCodeApi();
        const libreriaValue = document.getElementById('libreriaInput').value;
        const elementoValue = document.getElementById('elementoInput').value;

        // Escuchar mensajes desde el backend
        window.addEventListener('message', (event) => {
            const message = event.data;
            if (message.command === 'errorMessage') {
                // Actualizar el contenido del <p> con el valor de error.message
                document.getElementById('errorOutput').textContent = `Error: ${message.errorMessage}`;
                document.getElementById('progressBar').style.display = 'none';
            }
            if (message.command === 'stderrOutput') {
                // Actualizar el contenido del <p> con el valor de stderr
                document.getElementById('stderrOutput').textContent = `Stderr: ${message.stderr}`;
            }
            if (message.command === 'stdoutOutput') {
                // Actualizar el contenido del <p> con el valor de stdout
                document.getElementById('stdoutOutput').textContent = `Stdout: ${message.stdout}`;
                document.getElementById('progressBar').style.display = 'none';


                
                const stdout = message.stdout;

                // Dividir stdout en líneas
                const lines = stdout.split('\n');

                // Buscar la fila que comienza con "BUSCANDO"
                const startIndex = lines.findIndex(line => line.startsWith("BUSCANDO"));

                if (startIndex !== -1) {
                    // Buscar la fila que comienza con "ISPS118L"
                    const endIndex = lines.findIndex((line, index) => index > startIndex && line.startsWith("ISPS118L"));

                    // Extraer las líneas desde "BUSCANDO" hasta antes de "ISPS118L"
                    const resultLines = endIndex !== -1
                        ? lines.slice(startIndex, endIndex) // Desde "BUSCANDO" hasta antes de "ISPS118L"
                        : lines.slice(startIndex); // Desde "BUSCANDO" hasta el final si no hay "ISPS118L"

                    // Imprimir las líneas extraídas en el elemento <p>
                    document.getElementById('stdoutOutput').textContent = resultLines.join('\n');
                } else {
                    document.getElementById('stdoutOutput').textContent = 'No se encontró la fila que comienza con "BUSCANDO".';
                }

                document.getElementById('progressBar').style.display = 'none';
            }
        });

        document.getElementById('additionalOutput').textContent = libreriaValue + ' PRG ' + elementoValue;

        document.getElementById('libreriaInput').addEventListener('input', (event) => {
            const libreriaValue = event.target.value;
            const elementoValue = document.getElementById('elementoInput').value;
            document.getElementById('additionalOutput').textContent = libreriaValue + ' PRG' + elementoValue;
        });

        document.getElementById('matriculaBuscar').addEventListener('click', () => {
            const elementoValue = document.getElementById('elementoInput').value;
            const libreriaValue = document.getElementById('libreriaInput').value;
            const typeValue = document.getElementById('typeSelect').value;

            const zoweCommandConcat = 'zowe tso issue cmd "EX \'' + libreriaValue + '\' \'' + typeValue + ' ' + elementoValue + '\'" -a 9999/UTI/00';

            document.getElementById('commandOutput').textContent = 'Generated Command: ' + zoweCommandConcat;

            // Mostrar el progreso
            const progressBar = document.getElementById('progressBar');
            progressBar.style.display = 'block';

            vscode.postMessage({ command: 'runZoweCommand', zoweCommand: zoweCommandConcat });
        });
    </script>
</body>

</html>