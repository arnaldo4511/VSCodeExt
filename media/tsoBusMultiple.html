<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSO BUS Multiple</title>
    <style>
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .row2 {
            display: flex;
            flex-direction: row;
            /* Alinear elementos horizontalmente */
            align-items: flex-start;
            /* Alinear elementos al inicio verticalmente */
            gap: 20px;
            /* Espaciado entre los elementos */
        }

        #progressBar {
            width: 150px;
            /* Ancho de la barra de progreso */
        }
    </style>
</head>

<body>
    <h1>TSO BUS</h1>
    <div class="row" style="display: none;">
        <label for="libreriaInput">Libreria: </label>
        <input type="text" id="libreriaInput" value="T09579.JCLLIB(BU3)" />
    </div>

    <div class="row">
        <label for="elementosInput">Elementos:</label>
        <button id="elementosBuscar">Buscar</button>
    </div>
    <div class="row2">
        <textarea id="elementosInput" rows="20" cols="20">BCVVCU20;PRG
            BCVVCU21;PRG
            BCVVCU22;PRG</textarea>

        <progress id="progressBar" style="display: none;" max="100"></progress>

        <div id="resultsContainer"></div> <!-- Contenedor para los resultados -->
    </div>





    <p id="additionalOutput"></p>

    <p id="commandOutput"></p>

    <p id="errorOutput"></p>
    <p id="stderrOutput"></p>
    a
    <pre id="stdoutOutput"></pre>

    b
    <pre id="output"></pre>

    <script>
        const vscode = acquireVsCodeApi();



        const libreriaValue = document.getElementById('libreriaInput').value;
        const elementoValue = document.getElementById('elementosInput').value;



        

        //document.getElementById('additionalOutput').textContent = libreriaValue + ' PRG ' + elementoValue;

        /*document.getElementById('libreriaInput').addEventListener('input', (event) => {
            const libreriaValue = event.target.value;
            const elementoValue = document.getElementById('elementosInput').value;
            document.getElementById('additionalOutput').textContent = libreriaValue + ' PRG' + elementoValue;
        });*/


        document.getElementById('elementosBuscar').addEventListener('click', async () => {

            vscode.postMessage({ command: 'logMessage', text: "AQUI" });

            const elementoValue = document.getElementById('elementosInput').value;
            vscode.postMessage({ command: 'logMessage', text: `aqui2 ${elementoValue}` });
            const libreriaValue = document.getElementById('libreriaInput').value;
            vscode.postMessage({ command: 'logMessage', text: `aqui2 ${libreriaValue}` });

            // Dividir el contenido del textarea en líneas
            const lines = elementoValue.split('\n').filter(line => line.trim() !== '');

            vscode.postMessage({ command: 'logMessage', text: `aqui2 ${lines}` });

            // Configurar la barra de progreso
            const progressBar = document.getElementById('progressBar');
            progressBar.style.display = 'block';
            progressBar.max = lines.length;
            progressBar.value = 0;

            vscode.postMessage({ command: 'logMessage', text: `aqui2 ${progressBar}` });

            // Contenedor para los resultados
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = ''; // Limpiar resultados previos

            // Recorrer cada línea
            for (let i = 0; i < lines.length; i++) {

                vscode.postMessage({ command: 'logMessage', text: "--------------------------------------" });

                const line = lines[i].trim();
                const [elementoValue, typeValue] = line.split(';');

                if (!elementoValue || !typeValue) {
                    vscode.postMessage({
                        command: 'logMessage',
                        text: `Línea inválida: ${line}`
                    });
                    continue; // Saltar líneas inválidas
                }

                // Generar el comando Zowe CLI
                const zoweCommandConcat = 'zowe tso issue cmd "EX \'' + libreriaValue + '\' \'' + typeValue + ' ' + elementoValue + '\'" -a 9999/UTI/00';

                // Crear un nuevo <pre> para mostrar el resultado de esta consulta
                const preElement = document.createElement('pre');
                preElement.id = `result-${i}`;
                preElement.textContent = `Procesando: ${elementoValue} (${typeValue})...`;
                resultsContainer.appendChild(preElement);

                vscode.postMessage({ command: 'logMessage', text: `resultsContainer ${resultsContainer}` });

                vscode.postMessage({ command: 'logMessage', text: `zoweCommandConcat ${zoweCommandConcat}` });

                // Enviar el comando al backend
                vscode.postMessage({ command: 'runZoweCommand', zoweCommand: zoweCommandConcat });

                // Actualizar la barra de progreso
                progressBar.value = i + 1;

                // Esperar un breve momento para evitar saturar el backend
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Ocultar la barra de progreso al finalizar
            progressBar.style.display = 'none';

            vscode.postMessage({
                command: 'logMessage',
                text: 'Procesamiento completado para todos los elementos.'
            });
        });


        // Escuchar mensajes desde el backend
        window.addEventListener('message', (event) => {
            const message = event.data;


            vscode.postMessage({ command: 'logMessage', text: `message ${message}` });
            vscode.postMessage({ command: 'logMessage', text: `message.command ${message.command}` });
            vscode.postMessage({ command: 'logMessage', text: `message.response ${message.response}` });
            vscode.postMessage({ command: 'logMessage', text: `message.stdout ${message.stdout}` });
            vscode.postMessage({ command: 'logMessage', text: `message.stderr ${message.stderr}` });
            vscode.postMessage({ command: 'logMessage', text: `message.error ${message.error}` });

            vscode.postMessage({ command: 'logMessage', text: `message.command ${message.command}+` });
            vscode.postMessage({ command: 'logMessage', text: `message.command zoweResponse+` });
            vscode.postMessage({ command: 'logMessage', text: message.command });
            vscode.postMessage({ command: 'logMessage', text: 'zoweResponse' });

            if (message.command === 'zoweResponse') {




                const stdout = message.response;

                // Dividir stdout en líneas
                const lines = stdout.split('\n');

                // Buscar la fila que comienza con "BUSCANDO"
                const startIndex = lines.findIndex(line => line.startsWith("BUSCANDO"));

                if (startIndex !== -1) {
                    // Buscar la fila que comienza con "ISPS118L"
                    const endIndex = lines.findIndex((line, index) => index > startIndex && line.startsWith("ISPS118L"));

                    // Extraer las líneas desde "BUSCANDO" hasta antes de "ISPS118L"
                    const resultLines = endIndex !== -1
                        ? lines.slice(startIndex, endIndex) // Desde "BUSCANDO" hasta antes de "ISPS118L"
                        : lines.slice(startIndex); // Desde "BUSCANDO" hasta el final si no hay "ISPS118L"

                    // Imprimir las líneas extraídas en el elemento <p>
                    document.getElementById('stdoutOutput').textContent = resultLines.join('\n');

                    vscode.postMessage({
                        command: 'logMessage',
                        text: resultLines.join('\n')
                    });
                }
                // Mostrar mensaje en log
                vscode.postMessage({
                    command: 'logMessage',
                    text: "aqui"
                });

                // Mostrar la respuesta en el <pre>
                document.getElementById('output').textContent = message.response;

                // Ocultar el progreso
                //document.getElementById('progressBar').style.display = 'none';




                vscode.postMessage({ command: 'logMessage', text: 'IN' });

                vscode.postMessage({ command: 'logMessage', text: ` ADDEVENT ${stdout} ` });

                // Buscar el <pre> correspondiente al comando actual
                const preElement = document.querySelector(`#resultsContainer pre:last-child`);
                if (preElement) {
                    preElement.textContent = stdout; // Actualizar el contenido del <pre> con la respuesta
                }

                vscode.postMessage({ command: 'logMessage', text: ` preElement ${preElement} ` });

                vscode.postMessage({
                    command: 'logMessage',
                    text: `Respuesta recibida: ${stdout}`
                });

            }



        });


    </script>
</body>

</html>