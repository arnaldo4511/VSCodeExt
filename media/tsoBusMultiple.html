<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSO BUS Multiple</title>
    <style>
        * {
            font-family: "Courier New";
        }

        .row {
            display: flex;
            /* Alinear elementos horizontalmente */
            flex-direction: row;
            /* Mantener los elementos en una fila */
            align-items: flex-start;
            /* Alinear el contenido al inicio verticalmente */
            gap: 20px;
            /* Espaciado entre los elementos */
            margin-bottom: 5px;
            margin-top: 5px;

        }

        .fixed-width {
            width: 500px;
            /* Ancho fijo */
            word-wrap: break-word;
            /* Ajustar el texto si excede el ancho */
            white-space: pre-wrap;
            /* Mantener saltos de línea y ajustar el texto */
            border: 1px solid #ccc;
            /* Opcional: agregar un borde */
            padding: 10px;
            /* Opcional: agregar relleno */
            background-color: #000000;
            /* Opcional: agregar un fondo */
        }

        #progressBar {
            width: 150px;
            /* Ancho de la barra de progreso */
        }

        .bold {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>TSO BUS</h1>
    <div class="row" style="display: none;">
        <label for="libreriaInput">Libreria: </label>
        <input type="text" id="libreriaInput" value="T09579.JCLLIB(BU3)" />
    </div>

    <div class="row">
        <label for="elementosInput" class="bold">Elementos:</label>
        <button id="elementosBuscar" class="bold">Buscar</button>
        <progress id="progressBarMain" style="display: none;" max="100"></progress>
    </div>
    <div class="row">
        <b class="bold">Uso:</b>[ELEMENTO];[PRG]
    </div>
    
    <div class="row">
        <textarea id="elementosInput" rows="15" cols="20">BCVVCU20;PRG</textarea>

        <div class="row">
            <div id="resultsContainer"></div> <!-- Contenedor para los resultados -->
        </div>

    </div>

    <script>
        const vscode = acquireVsCodeApi();



        const libreriaValue = document.getElementById('libreriaInput').value;
        const elementoValue = document.getElementById('elementosInput').value;





        document.getElementById('elementosBuscar').addEventListener('click', async () => {

            vscode.postMessage({ command: 'logMessage', text: "click" });

            const elementoValue = document.getElementById('elementosInput').value;
            vscode.postMessage({ command: 'logMessage', text: `click elementoValue: ${elementoValue}` });
            const libreriaValue = document.getElementById('libreriaInput').value;
            vscode.postMessage({ command: 'logMessage', text: `click libreriaValue: ${libreriaValue}` });

            // Dividir el contenido del textarea en líneas
            const lines = elementoValue.split('\n').filter(line => line.trim() !== '');

            vscode.postMessage({ command: 'logMessage', text: `click lines: ${lines}` });

            // Configurar la barra de progreso
            const progressBarMain = document.getElementById('progressBarMain');
            progressBarMain.style.display = 'block';
            //progressBar.max = lines.length;
            //progressBar.value = 0;


            // Contenedor para los resultados
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = ''; // Limpiar resultados previos

            // Recorrer cada línea
            for (let i = 0; i < lines.length; i++) {

                vscode.postMessage({ command: 'logMessage', text: " click for --------------------------------------" });

                const line = lines[i].trim();
                const [elementoValue, typeValue] = line.split(';');

                if (!elementoValue || !typeValue) {
                    vscode.postMessage({
                        command: 'logMessage',
                        text: `click for Línea inválida: ${line}`
                    });
                    continue; // Saltar líneas inválidas
                }

                // Generar el comando Zowe CLI
                const zoweCommandConcat = 'zowe tso issue cmd "EX \'' + libreriaValue + '\' \'' + typeValue + ' ' + elementoValue + '\'" -a 9999/UTI/00';

                // Crear un nuevo <pre> para mostrar el resultado de esta consulta
                const pElement = document.createElement('p');
                pElement.id = `resultP-${i}`;
                pElement.textContent = `${elementoValue} - ${typeValue}`;
                pElement.style.fontWeight = 'bold'; // Aplicar negrita directamente
                //pElement.style.textDecoration = 'underline'; // Aplicar subrayado directamente
                pElement.classList.add('row');
                resultsContainer.appendChild(pElement);

                // Crear una barra de progreso para esta consulta
                const progressBar = document.createElement('progress');
                progressBar.id = `progress-${i}`;
                //progressBar.max = 100;
                //progressBar.value = 0;
                progressBar.classList.add('row');
                resultsContainer.appendChild(progressBar);

                // Crear un nuevo <pre> para mostrar el resultado de esta consulta
                const preElement = document.createElement('pre');
                preElement.id = `result-${i}`;
                preElement.classList.add('fixed-width');
                preElement.textContent = `Procesando: ${elementoValue} (${typeValue})...`;
                resultsContainer.appendChild(preElement);

                vscode.postMessage({ command: 'logMessage', text: `click for i ${i}` });
                vscode.postMessage({ command: 'logMessage', text: `click for preElement.id ${preElement.id}` });
                vscode.postMessage({ command: 'logMessage', text: `click for preElement.textContent ${preElement.textContent}` });

                vscode.postMessage({ command: 'logMessage', text: `click for resultsContainer ${resultsContainer}` });

                vscode.postMessage({ command: 'logMessage', text: `click for zoweCommandConcat ${zoweCommandConcat}` });

                // Simular progreso inicial
                //progressBar.value = 50;

                // Enviar el comando al backend
                vscode.postMessage({ command: 'runZoweCommand', zoweCommand: zoweCommandConcat, index: i });

                // Actualizar la barra de progreso
                //progressBar.value = i + 1;

                // Esperar un breve momento para evitar saturar el backend
                await new Promise(resolve => setTimeout(resolve, 500));
            }



            vscode.postMessage({
                command: 'logMessage',
                text: 'click Procesamiento completado para todos los elementos.'
            });
        });


        // Escuchar mensajes desde el backend
        window.addEventListener('message', (event) => {
            const message = event.data;


            vscode.postMessage({ command: 'logMessage', text: `message ${message}` });
            vscode.postMessage({ command: 'logMessage', text: `message.command ${message.command}` });
            vscode.postMessage({ command: 'logMessage', text: `message.response ${message.response}` });
            vscode.postMessage({ command: 'logMessage', text: `message.stdout ${message.stdout}` });
            vscode.postMessage({ command: 'logMessage', text: `message.stderr ${message.stderr}` });
            vscode.postMessage({ command: 'logMessage', text: `message.error ${message.error}` });

            vscode.postMessage({ command: 'logMessage', text: `message.command ${message.command}+` });
            vscode.postMessage({ command: 'logMessage', text: `message.command zoweResponse+` });
            vscode.postMessage({ command: 'logMessage', text: message.command });
            vscode.postMessage({ command: 'logMessage', text: 'zoweResponse' });

            if (message.command === 'zoweResponse') {
                const progressBarMain = document.getElementById('progressBarMain');


                vscode.postMessage({ command: 'logMessage', text: ` progressBarMain ${progressBarMain} ` });
                vscode.postMessage({ command: 'logMessage', text: ` progressBarMain.style.display ${progressBarMain.style.display} ` });

                const progressBarId = `progress-${message.index}`;
                const progressBar = document.getElementById(progressBarId);

                //progressBar.value = 75;

                const stdout = message.response;

                // Dividir stdout en líneas
                const lines = stdout.split('\n');

                // Buscar la fila que comienza con "BUSCANDO"
                const startIndex = lines.findIndex(line => line.startsWith("BUSCANDO"));

                if (startIndex !== -1) {
                    // Buscar la fila que comienza con "ISPS118L"
                    const endIndex = lines.findIndex((line, index) => index > startIndex && line.startsWith("ISPS118L"));

                    // Extraer las líneas desde "BUSCANDO" hasta antes de "ISPS118L"
                    const resultLines = endIndex !== -1
                        ? lines.slice(startIndex, endIndex) // Desde "BUSCANDO" hasta antes de "ISPS118L"
                        : lines.slice(startIndex); // Desde "BUSCANDO" hasta el final si no hay "ISPS118L"

                    // Imprimir las líneas extraídas en el elemento <p>
                    //document.getElementById('stdoutOutput').textContent = resultLines.join('\n');

                    vscode.postMessage({ command: 'logMessage', text: ` ADDEVENT ${stdout} ` });

                    // Buscar el <pre> correspondiente al comando actual
                    //const preElement = document.querySelector(`#resultsContainer pre:last-child`);
                    const preElementId = `result-${message.index}`;
                    vscode.postMessage({ command: 'logMessage', text: ` message.index ${message.index} ` });
                    vscode.postMessage({ command: 'logMessage', text: ` preElementId ${preElementId} ` });
                    const preElement = document.getElementById(preElementId);
                    if (preElement) {
                        //preElement.textContent = stdout; // Actualizar el contenido del <pre> con la respuesta
                        preElement.textContent = "aaa " + resultLines.join('\n'); // Actualizar el contenido del <pre> con la respuesta

                    }





                    vscode.postMessage({ command: 'logMessage', text: resultLines.join('\n') });
                } else {

                    // Buscar el <pre> correspondiente al comando actual
                    //const preElement = document.querySelector(`#resultsContainer pre:last-child`);
                    const preElementId = `result-${message.index}`;
                    vscode.postMessage({ command: 'logMessage', text: ` message.index ${message.index} ` });
                    vscode.postMessage({ command: 'logMessage', text: ` preElementId ${preElementId} ` });
                    const preElement = document.getElementById(preElementId);
                    if (preElement) {
                        //preElement.textContent = stdout; // Actualizar el contenido del <pre> con la respuesta
                        preElement.textContent = "bbb " + message.response; // Actualizar el contenido del <pre> con la respuesta

                    }



                    // Si no se encuentra "BUSCANDO", mostrar un mensaje de error
                    //document.getElementById('stdoutOutput').textContent = "No se encontró la línea 'BUSCANDO' en la salida.";
                }

                // Mostrar mensaje en log
                vscode.postMessage({ command: 'logMessage', text: "aqui" });

                // Mostrar la respuesta en el <pre>
                //document.getElementById('output').textContent = message.response;

                // Ocultar el progreso
                //document.getElementById('progressBar').style.display = 'none';

                // Finalizar la barra de progreso correspondiente

                //if (progressBar) {
                    //progressBar.value = 100; // Completar la barra de progreso
                    setTimeout(() => progressBar.remove(), 1000); // Eliminar la barra después de 1 segundo
                //}

                vscode.postMessage({ command: 'logMessage', text: ` preElement ` });
                vscode.postMessage({ command: 'logMessage', text: ` progressBarMain ${progressBarMain} ` });


                vscode.postMessage({ command: 'logMessage', text: `Respuesta recibida: ${stdout}` });

                vscode.postMessage({ command: 'logMessage', text: ` progressBarMain.style.display ${progressBarMain.style.display} ` });

                // Ocultar la barra de progreso al finalizar
                progressBarMain.style.display = 'none';

                vscode.postMessage({ command: 'logMessage', text: ` progressBarMain.style.display ${progressBarMain.style.display} ` });
            }

        });


    </script>
</body>

</html>